<!DOCTYPE html>
<html lang="en">
<head>
  <title>OJT Student - Work Track</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="/css/style_client.css">
  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body, html { height:100%; margin:0; font-family: Arial, sans-serif; }
    .container { width:80%; margin:auto; padding:20px; }
    .header { display:flex; justify-content:flex-end; margin-bottom:20px; }
    .time-block label { font-size:1.2em; }
    .time-entry input { padding:10px; margin:5px; border:1px solid #ccc; border-radius:5px; }
    .work-track, .work-history table { width:100%; border-collapse:collapse; margin-top:20px; }
    .work-track th, .work-history th { background:#4CAF50; color:#fff; padding:10px; border:1px solid #ddd; }
    .work-track td, .work-history td { padding:10px; border:1px solid #ddd; text-align:center; }
    h2 { color:#333; }
    .left-manager { width:200px; float:left; background:#333; height:100vh; color:#fff; }
    .left-manager .client-task { list-style:none; padding:0; }
    .left-manager .client-task .work { padding:10px; border-bottom:1px solid #444; }
    .left-manager .client-task .work a { color:#fff; text-decoration:none; display:block; }
    .container { margin-left:220px; }
    .clearfix::after { content:""; display:table; clear:both; }
    .logout-button { background:#e0f7fa; padding:10px; border-radius:5px; text-decoration:none; color:#00695c; display:inline-block; cursor:pointer; transition:background-color .3s; }
    .logout-button:hover { background:#b2ebf2; }
  </style>
</head>
<body>
  <div class="left-manager">
    <div class="client-task">
      <li class="work"><a href="/intern_profile">Profile</a></li>
      <li class="work"><a href="/intern_worktrack">Work Track</a></li>
      <li class="work"><a id="logoutButton" class="logout-button" href="/logout">Logout</a></li>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="time-block">
        <div id="current-time"></div>
      </div>
    </div>

    <% records.forEach(function(record) { %>
      <% if (record.record_status !== 'Completed') { %>
        <form action="/submit_time_entry" method="post">
          <input type="hidden" name="record_id" value="<%= record.record_id %>">
          <div class="time-entry">
            <label for="date-<%= record.record_id %>">Date:</label>
            <input type="date"
                   id="date-<%= record.record_id %>"
                   name="date"
                   required
                   min="<%= record.dateMin %>"
                   max="<%= record.dateMax %>">

            <label for="hours-<%= record.record_id %>">Hours Submitted:</label>
            <input type="number"
                   id="hours-<%= record.record_id %>"
                   name="hoursSubmit"
                   step="0.25"
                   min="0.25"
                   max="<%= Math.min(8, Number(record.hours_remaining)) %>"
                   required>

            <button type="submit">Submit Time Entry</button>
          </div>
        </form>
      <% } else { %>
        <p>Your internship has been completed. No further time entry is required.</p>
      <% } %>
    <% }) %>

    <table class="work-track">
      <thead>
        <tr>
          <th>Adviser</th>
          <th>Hours Completed</th>
          <th>Hours Remaining</th>
          <th>Supervisor</th>
          <th>Start Date</th>
          <th>End Date</th>
          <th>Progress</th>
        </tr>
      </thead>
      <tbody>
        <% records.forEach(function(record) { %>
          <tr>
            <td><%= record.adviserFirstName %> <%= record.adviserLastName %></td>
            <td><%= Number(record.hours_completed).toFixed(0) %></td>
            <td><%= Number(record.hours_remaining).toFixed(0) %></td>
            <td><%= record.supervisorFirstName %> <%= record.supervisorLastName %></td>
            <td><%= record.start_date_str %></td>
            <td><%= record.end_date_str %></td>
            <td><%= record.record_status %></td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <div class="work-history">
      <h2>Work Track History</h2>
      <table>
        <thead>
          <tr><th>Date</th><th>Hours Rendered</th></tr>
        </thead>
        <tbody>
          <% timeEntries.forEach(function(entry) { %>
            <tr>
              <td><%= entry.date_str %></td>
              <td><%= entry.hours_submit %></td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    function updateCurrentTime() {
      const el = document.getElementById('current-time');
      const now = new Date();
      el.textContent = String(now.getHours()).padStart(2,'0') + ':' +
                       String(now.getMinutes()).padStart(2,'0') + ':' +
                       String(now.getSeconds()).padStart(2,'0');
    }
    updateCurrentTime(); setInterval(updateCurrentTime, 1000);
  </script>

<% if (message) { %>
<script>
  (function(){
    var msg = <%- JSON.stringify(message.text || message) %>;
    // show after first paint; wonâ€™t re-fire on bfcache restore
    requestAnimationFrame(function(){
      requestAnimationFrame(function(){ alert(msg); });
    });
  })();
</script>
<% } %>
</body>
</html>
